<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex Islands - Lobby</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #00aaff, #0088cc); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 10px; }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; padding: 25px; background: #f8f9fa; border-radius: 15px; border-left: 4px solid #00aaff; }
        .section h2 { color: #00aaff; margin-bottom: 15px; font-weight: 600; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; font-family: 'Poppins'; }
        input:focus { outline: none; border-color: #00aaff; }
        button { background: #00aaff; color: white; border: none; padding: 12px 25px; border-radius: 10px; font-size: 16px; font-family: 'Poppins'; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        button:hover { background: #0088cc; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,170,255,0.3); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-orange { background: #ff4500; }
        .btn-orange:hover { background: #e03d00; }
        .user-list { list-style: none; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .user-name { flex: 1; font-weight: 500; }
        .status { display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; margin-right: 10px; }
        .status.online { background: #e8f5e8; color: #2e7d32; }
        .notification { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .error { background: #f8d7da; color: #721c24; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #c3e6cb; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Vortex Islands</h1>
            <p>Real-time Multiplayer Strategy Game</p>
        </div>
        
        <div class="content">
            <div class="section" id="usernameSection">
                <h2>Enter Your Username</h2>
                <div class="input-group">
                    <input type="text" id="usernameInput" placeholder="Choose a username (max 20 characters)" maxlength="20">
                    <button onclick="setUsername()">Join Game</button>
                </div>
            </div>
            
            <div class="section hidden" id="onlineSection">
                <h2>Online Players</h2>
                <div id="userList" class="user-list">
                    <div>Loading online users...</div>
                </div>
            </div>
            
            <div class="section hidden" id="notificationsSection">
                <h2>Game Requests</h2>
                <div id="notificationsList"></div>
            </div>
            
            <div id="statusMessage"></div>
        </div>
    </div>

    <!-- Remove this line: <script src="/socket.io/socket.io.js"></script> -->
<!-- Add this CDN instead: -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let currentUsername = '';
        // In both index.html and game.html, update the socket connection:
const socket = io('https://vortex-islands.vercel.app', {
  transports: ['websocket', 'polling']
});
        
        function setUsername() {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            
            if (!username) {
                showError('Please enter a username');
                return;
            }
            
            fetch(`/user?q=${encodeURIComponent(username)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    currentUsername = username;
                    showSuccess(`Welcome, ${username}!`);
                    document.getElementById('usernameSection').classList.add('hidden');
                    document.getElementById('onlineSection').classList.remove('hidden');
                    document.getElementById('notificationsSection').classList.remove('hidden');
                    
                    // Initialize Socket.io connection
                    initializeSocket();
                    loadOnlineUsers();
                }
            })
            .catch(error => {
                showError('Failed to set username. Please try again.');
            });
        }
        
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('✅ Connected to server');
                // Register user with socket
                socket.emit('register', currentUsername);
            });
            
            socket.on('registered', (data) => {
                console.log('✅ User registered with socket');
            });
            
            socket.on('game_request', (data) => {
                showNotification(data.from);
            });
            
            socket.on('game_start', (data) => {
                window.location.href = `/game?gameId=${data.gameId}&username=${currentUsername}`;
            });
            
            socket.on('error', (data) => {
                showError(data.message);
            });
            
            socket.on('disconnect', () => {
                showError('Disconnected from server. Reconnecting...');
            });
        }
        
        function loadOnlineUsers() {
            fetch('/online')
                .then(response => response.json())
                .then(users => {
                    const userList = document.getElementById('userList');
                    userList.innerHTML = '';
                    
                    const otherUsers = users.filter(user => user !== currentUsername);
                    
                    if (otherUsers.length === 0) {
                        userList.innerHTML = '<div>No other players online</div>';
                        return;
                    }
                    
                    otherUsers.forEach(user => {
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <span class="user-name">${user}</span>
                            <span class="status online">Online</span>
                            <button onclick="sendGameRequest('${user}')">Play</button>
                        `;
                        userList.appendChild(userItem);
                    });
                })
                .catch(error => {
                    document.getElementById('userList').innerHTML = '<div class="error">Failed to load online users</div>';
                });
        }
        
        function sendGameRequest(opponent) {
            socket.emit('send_game_request', {
                username: opponent,
                sender: currentUsername
            });
            showSuccess(`Game request sent to ${opponent}`);
        }
        
        function showNotification(sender) {
            const notificationsList = document.getElementById('notificationsList');
            const existingNotification = Array.from(notificationsList.children).find(
                child => child.textContent.includes(sender)
            );
            
            if (existingNotification) return;
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <span>Game request from <strong>${sender}</strong></span>
                <button class="btn-orange" onclick="acceptGameRequest('${sender}')">Accept</button>
            `;
            notificationsList.appendChild(notification);
        }
        
        function acceptGameRequest(sender) {
            socket.emit('accept_game_request', {
                username: currentUsername,
                sender: sender
            });
            
            // Remove notification
            const notificationsList = document.getElementById('notificationsList');
            Array.from(notificationsList.children).forEach(child => {
                if (child.textContent.includes(sender)) {
                    child.remove();
                }
            });
        }
        
        function showError(message) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => { statusDiv.innerHTML = ''; }, 5000);
        }
        
        function showSuccess(message) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
        }
    </script>
</body>
</html>
