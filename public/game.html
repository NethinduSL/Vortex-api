<script>
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('gameId');
    const username = urlParams.get('username');
    
    let currentState = null;
    let statePollInterval = null;
    let statusPollInterval = null;
    let joinAttempts = 0;
    const maxJoinAttempts = 10;

    // Simple error handler
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        console.error('Game Error:', message);
    }

    function hideError() {
        document.getElementById('errorMessage').classList.add('hidden');
    }

    function showStatus(message) {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.innerHTML = message;
    }

    // Initialize game
    document.addEventListener('DOMContentLoaded', () => {
        if (!gameId || !username) {
            showError('Missing game ID or username. Redirecting to lobby...');
            setTimeout(() => window.location.href = '/', 3000);
            return;
        }
        
        console.log('üéÆ Starting game:', { gameId, username });
        document.getElementById('playerName').textContent = `${username}'s Island`;
        document.getElementById('playerInfo').textContent = `Player: ${username}`;
        
        startGame();
    });
    
    function startGame() {
        joinGame();
        startStatusPolling();
        startStatePolling();
    }
    
    function joinGame() {
        if (joinAttempts >= maxJoinAttempts) {
            showError('Failed to join game after multiple attempts. Please try again.');
            return;
        }
        
        joinAttempts++;
        console.log(`üîó Join attempt ${joinAttempts} for game ${gameId}`);
        
        fetch(`/game-action/${gameId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'join', username: username })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            console.log('‚úÖ Successfully joined game');
            hideError();
            updateGameState(data.state);
        })
        .catch(error => {
            console.error('Join failed:', error.message);
            showError(`Join failed: ${error.message}. Retrying...`);
            setTimeout(joinGame, 2000);
        });
    }
    
    function startStatusPolling() {
        statusPollInterval = setInterval(() => {
            fetch(`/game-status/${gameId}?username=${encodeURIComponent(username)}`)
                .then(response => {
                    if (!response.ok) throw new Error(`Status error: ${response.status}`);
                    return response.json();
                })
                .then(status => {
                    updateConnectionStatus(status);
                })
                .catch(error => {
                    console.log('Status poll error:', error.message);
                });
        }, 2000); // Poll status every 2 seconds
    }
    
    function startStatePolling() {
        statePollInterval = setInterval(() => {
            fetch(`/game-state/${gameId}`)
                .then(response => {
                    if (!response.ok) throw new Error(`State error: ${response.status}`);
                    return response.json();
                })
                .then(state => {
                    if (state.error) throw new Error(state.error);
                    hideError();
                    updateGameState(state);
                })
                .catch(error => {
                    console.log('State poll error:', error.message);
                    showError(`Connection issue: ${error.message}. Retrying...`);
                });
        }, 3000); // Poll state every 3 seconds
    }
    
    function updateConnectionStatus(status) {
        const connectionDiv = document.getElementById('connectionStatus');
        
        if (status.playersConnected === 2) {
            connectionDiv.innerHTML = '‚úÖ <span>Connected - Game Ready!</span>';
            connectionDiv.className = 'connection-status status-connected';
        } else if (status.playersConnected === 1) {
            connectionDiv.innerHTML = '‚è≥ <span>Waiting for opponent to join...</span>';
            connectionDiv.className = 'connection-status';
        } else {
            connectionDiv.innerHTML = 'üîó <span>Connecting to game server...</span>';
            connectionDiv.className = 'connection-status';
        }
    }
    
    function updateGameState(state) {
        currentState = state;
        
        // Update game phase
        document.getElementById('gamePhase').textContent = `Phase: ${state.phase.toUpperCase()}`;
        
        // Update islands
        updateIslandDisplay('player', state.islands[username], state.scores[username]);
        const opponent = state.players.find(p => p !== username);
        if (opponent) {
            document.getElementById('opponentName').textContent = `${opponent}'s Island`;
            updateIslandDisplay('opponent', state.islands[opponent], state.scores[opponent]);
        }
        
        // Update game log
        updateGameLog(state.moves);
        
        // Update controls based on game state
        updateControls(state, opponent);
        
        // Check for game over
        if (state.gameOver) {
            showGameOver(state);
        }
    }
    
    function updateIslandDisplay(type, island, score) {
        document.getElementById(`${type}Parts`).textContent = `Parts: ${island.parts}`;
        document.getElementById(`${type}Shields`).textContent = `Shields: ${island.shields}`;
        document.getElementById(`${type}Score`).textContent = `Score: ${score}`;
    }
    
    function updateGameLog(moves) {
        const logContainer = document.getElementById('gameLog');
        logContainer.innerHTML = '';
        
        // Show latest moves first
        moves.slice().reverse().forEach(move => {
            const message = document.createElement('div');
            message.className = 'log-message';
            message.textContent = move;
            logContainer.appendChild(message);
        });
    }
    
    function updateControls(state, opponent) {
        const isMyTurn = state.turn === username;
        const isRPSPhase = state.phase === 'rps';
        const isActionPhase = state.phase === 'action';
        const isWinner = state.winner === username;
        const hasChosenRPS = state.pendingRPS && state.pendingRPS[username];
        
        // Show/hide phases
        document.getElementById('rpsPhase').style.display = isRPSPhase ? 'block' : 'none';
        document.getElementById('actionPhase').style.display = isActionPhase ? 'block' : 'none';
        
        // Enable/disable RPS buttons
        const canChooseRPS = isRPSPhase && isMyTurn && !hasChosenRPS && state.playersConnected === 2;
        document.getElementById('rockBtn').disabled = !canChooseRPS;
        document.getElementById('paperBtn').disabled = !canChooseRPS;
        document.getElementById('officerBtn').disabled = !canChooseRPS;
        
        // Enable/disable action buttons
        const canTakeAction = isActionPhase && isMyTurn && isWinner && state.playersConnected === 2;
        document.getElementById('mortarBtn').disabled = !canTakeAction;
        document.getElementById('shieldBtn').disabled = !canTakeAction;
        document.getElementById('slicerBtn').disabled = !canTakeAction;
        
        // Update status messages
        document.getElementById('playerStatus').textContent = getStatusMessage(state, username, true);
        document.getElementById('opponentStatus').textContent = getStatusMessage(state, opponent, false);
            
        // Highlight active islands
        document.getElementById('playerIsland').classList.toggle('active', isMyTurn);
        document.getElementById('opponentIsland').classList.toggle('active', !isMyTurn && opponent);
    }
    
    function getStatusMessage(state, player, isSelf) {
        if (!player) return 'Waiting...';
        
        const isTheirTurn = state.turn === player;
        const hasChosenRPS = state.pendingRPS && state.pendingRPS[player];
        
        if (state.phase === 'rps') {
            if (isTheirTurn) {
                return hasChosenRPS ? '‚úÖ Choice made!' : 'üéØ Your turn - Choose RPS!';
            } else {
                return hasChosenRPS ? '‚úÖ Choice made' : '‚è≥ Waiting for choice...';
            }
        } else if (state.phase === 'action') {
            if (isTheirTurn) {
                return 'üéØ Your turn - Take action!';
            } else {
                return '‚è≥ Waiting for action...';
            }
        }
        return '‚è≥ Waiting...';
    }
    
    function makeRPSChoice(choice) {
        // Disable buttons immediately
        document.getElementById('rockBtn').disabled = true;
        document.getElementById('paperBtn').disabled = true;
        document.getElementById('officerBtn').disabled = true;
        
        fetch(`/game-action/${gameId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'rps', username: username, choice: choice })
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.error) showError(data.error);
            // State will update via polling
        })
        .catch(error => {
            showError('Failed to make choice: ' + error.message);
            // Re-enable buttons on error
            if (currentState && currentState.phase === 'rps' && currentState.turn === username) {
                document.getElementById('rockBtn').disabled = false;
                document.getElementById('paperBtn').disabled = false;
                document.getElementById('officerBtn').disabled = false;
            }
        });
    }
    
    function makeAction(action) {
        // Disable buttons immediately
        document.getElementById('mortarBtn').disabled = true;
        document.getElementById('shieldBtn').disabled = true;
        document.getElementById('slicerBtn').disabled = true;
        
        fetch(`/game-action/${gameId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'action', username: username, action: action })
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.error) showError(data.error);
            // State will update via polling
        })
        .catch(error => {
            showError('Failed to perform action: ' + error.message);
            // Re-enable buttons on error
            if (currentState && currentState.phase === 'action' && currentState.turn === username) {
                document.getElementById('mortarBtn').disabled = false;
                document.getElementById('shieldBtn').disabled = false;
                document.getElementById('slicerBtn').disabled = false;
            }
        });
    }
    
    function showGameOver(state) {
        clearInterval(statePollInterval);
        clearInterval(statusPollInterval);
        
        const opponent = state.players.find(p => p !== username);
        const playerWon = state.islands[username].parts > 0;
        
        const modal = document.getElementById('gameOverModal');
        const title = document.getElementById('gameOverTitle');
        const message = document.getElementById('gameOverMessage');
        
        if (playerWon) {
            title.textContent = 'üéâ Victory!';
            title.style.color = '#00aaff';
            message.textContent = `You destroyed ${opponent}'s island! Congratulations!`;
        } else {
            title.textContent = 'üí• Defeat';
            title.style.color = '#ff4500';
            message.textContent = `${opponent} destroyed your island! Better luck next time!`;
        }
        
        modal.classList.remove('hidden');
    }
    
    // Keep user online status updated
    setInterval(() => {
        if (username) {
            fetch(`/user?q=${encodeURIComponent(username)}`)
                .catch(error => console.log('Status update failed:', error.message));
        }
    }, 30000);
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        if (statePollInterval) clearInterval(statePollInterval);
        if (statusPollInterval) clearInterval(statusPollInterval);
    });
</script>
